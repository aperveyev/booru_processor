BOORU CHARS - миниатюры 1280 px и метаданые Safebooru и других имиджборд

BOORU CHARS OPEN DATASET - попытка сконцентрировать и систематизировать общедоступный персонажный anime/CG/game арт
в локализованном виде, подходящем и для автоматизированной обработки и для визуальной оценки (ня !).
Помимо картинок в разумном (компромиссном) качестве датасет содержит информацию о тегах (формальных описательных
признаках содержимого) и некоторых технических и статистических характеристиках изображений.

Далее приведено описание содержимого датасета и процесса его создания в версии на момент торрент-релиза (05.2021)
На Git https://github.com/aperveyev/booru_processor материалов больше и они обновляются.
Предыдущая версия датасета (2019, 512px)  https://rutracker.org/forum/viewtopic.php?t=5825224

Фундаментом мероприятия является набор сайтов (т.н. booru imageboards), содержащих изображения и набор сопутствующих 
метаданных к ним. Семейство этих более-менее подобных между собой booru (широко практикующих кросспостинг в целом 
согласующих метаданные) может рассматриваться как своеобразная тематическая распределенная база данных.
Пользовательское сообщество пополняет booru (в основном извлекая картинки с pixiv, deviantart и других относительно
недоступных закромов), описывает их тегами (формальными признаками содержимого) и коллективно формирует рейтинги
(как популярности, так и "приличия" - safe / questionable = эротика / explicit = явный хентай). 

Существует множество booru, они возникают и исчезают, имеют свои особенности - в тематике, тегах, рамках приличия и т.д.
Крупнейшие из них существуют 10+ лет и в итоге накапливают сотни тысяч и миллионы картинок, в частности стоят упоминания:
* safebooru.org - большой ресурс без откровенной эротики и хентая, служит основой датасета (3.3 млн постов на начало 2021)
* yande.re - специализируется на высококачественных сканах, процент "уникальности" постов высок, есть хентай (почти 0.8 млн)
* gelbooru.com - "полный" вариант safebooru без моральных ограничений (6+ млн)
* e-shuushuu.net - самый приличный и тщательно подобранный из ресурсов, специфичное тегирование, в последние годы затухает (1 млн)
* anime-pictures.net - не очень большой (почти 0.7 млн) но с хорошим подбором и только умеренной эротикой
* konachan.com - специализируется на "обоях" (ландшафтной ориентации), хороший подбор, есть хентай (0.32 млн)
* danbooru.donmai.us - классика booru-строения, качественное коммюнити (4.5 млн) практически полностью кросспостится, есть хентай
* www.zerochan.net - огромный (3.3 млн) и уникальный (по тегам и контенту) ресурс, один из "столпов" датасета, эротика умеренна
* chan.sankakucomplex.com - крупнейший за счет хентая (15+ млн додзинси и gameCG), но и обычный арт представлен богато (~8 млн) 
* theanimegallery.com, animepapers.net - в свое время были топовыми, RIP
Стоит упомянуть "специализированный" поиск по вышеупомянутым и другим ресурсам iqdb.org с охватом порядка 17 млн. изображений

Имиджборды в большинстве своем предоставляют доступ и не слишком ограничивают средства автоматизированного скачивания
(кроме тех, кто зарабатывает на порно - это я про sankakucomplex). Соответственно появляются (и исчезают, устаревая) 
приемлемые программулины для массового даунлоада, работающие с тем и не работающие с этим, и наоборот. Также, никто не отменял 
самопального программирования (парсинг сайтов, скачивание и логирование, переименование добытого) на любом подходящем тулките.
В данном описании процесс добычи исходников в основном будет оставлен за кадром, упомяну только 
* "bionus imgbrd grabber" на данный момент хорошо работающий с safebooru, yande-re, gelbooru, anime-pictures, konachan
* библиотеки python (requests, BeautifulSoup, json, re, ...) позволяющие парсить и качать типичную booru ценою полсотни строк кода

ВАЖНОЕ ПРИМЕЧАНИЕ: при создании датасета огромную роль сыграла реляционная база данных, в которой хранится и обрабатывается
вся информация, помимо собственно картинок. Широко упоминаемые далее метаданные хранятся в таблицах базы (Oracle XE) и извлекаются 
с помощью SQL-запросов, на этом будут основаны соответствующие описания структур и алгоритмов. Обработка картинок выполняется
пакетными файлами операционной системы (Windows) с помощью инструментов ImageMagick, Python (с необходимыми библиотеками), 
команд xcopy/move - все это будет в необходимой степени цитироваться. При этом описания вспомагательных действий и методов
(безусловные конверсии, дедубликация, загрузка в БД, индексирование и т.п.) будут опущены.

Многолетняя деятельность в booru-сфере привела к накоплению ряда "первичных, почти оригинальных" массивов скачанных данных в виде
ряда torrent-релизов, ключевыми из которых можно считать (приведено наименование корневой папки торрента):
e-shuushuu       - https://rutracker.org/forum/viewtopic.php?t=3612068 (все размеры, без фильтров конверсий)
e-shuushuu 2013  - https://rutracker.org/forum/viewtopic.php?t=4462893
e-shuushuu 2013s - https://rutracker.org/forum/viewtopic.php?t=4575912
e-shuushuu 2014  - https://rutracker.org/forum/viewtopic.php?t=4583098
e-shuushuu 2015  - https://rutracker.org/forum/viewtopic.php?t=4952787
e-shuushuu 2016  - https://rutracker.org/forum/viewtopic.php?t=5184361
e-shuushuu 2017  - https://rutracker.org/forum/viewtopic.php?t=5397445
e-shuushuu 2018  - https://rutracker.org/forum/viewtopic.php?t=5582710
e-shuushuu_2020  - https://rutracker.org/forum/viewtopic.php?t=5992196 
Safebooru 1280   - https://rutracker.org/forum/viewtopic.php?t=4290958 (мифология Safebooru, фильтр по размерам, PNG -> JPG)
Safebooru 1280 b - https://rutracker.org/forum/viewtopic.php?t=4299337
Safebooru pages - https://rutracker.org/forum/viewtopic.php?t=5019245
                и https://rutracker.org/forum/viewtopic.php?t=5015464
Safebooru 2M    - https://rutracker.org/forum/viewtopic.php?t=5249833 (все еще только только Safebooru) 
Safebooru 2017  - https://rutracker.org/forum/viewtopic.php?t=5449970 (добавлены Gelbooru и Yande.re)
Safebooru 2018  - https://rutracker.org/forum/viewtopic.php?t=5673690 (дальше - все больше источников)
                и https://rutracker.org/forum/viewtopic.php?t=5561386 
Safebooru 2019  - https://rutracker.org/forum/viewtopic.php?t=5818522
Safebooru 2020a - https://rutracker.org/forum/viewtopic.php?t=5862448
Safebooru 2020b - https://rutracker.org/forum/viewtopic.php?t=5922193
Safebooru 2020c - https://rutracker.org/forum/viewtopic.php?t=5957382
Safebooru 2020d - https://rutracker.org/forum/viewtopic.php?t=6006875
Safebooru 2021a - https://rutracker.org/forum/viewtopic.php?t=6045099 (актуальный композитный рип)
Sankaku 2013 wallsHD - https://rutracker.org/forum/viewtopic.php?t=4621394 (мифология sankaku, очень избирательно, PNG -> JPG)
Sankaku 2014    - https://rutracker.org/forum/viewtopic.php?t=4687961 (выдающийся источник - тогда и сейчас)
Sankaku 2015    - https://rutracker.org/forum/viewtopic.php?t=4908019
Sankaku 2015b   - https://rutracker.org/forum/viewtopic.php?t=5037455
Sankaku 2016a   - https://rutracker.org/forum/viewtopic.php?t=5216374
Sankaku 2016b   - https://rutracker.org/forum/viewtopic.php?t=5255630
Sankaku 2016c   - https://rutracker.org/forum/viewtopic.php?t=5312593 (шара закончилась, sankaku законопатился)
zerochan_2014s  - https://nyaa.si/view/1336359 (ранние материалы, уменьшены до 1920 px, не представлен на rutracker, PNG -> JPG)
zerochan_2016   - https://nyaa.si/view/1313832 (не представлен на rutracker, PNG -> JPG)
zerochan-2017   - https://rutracker.org/forum/viewtopic.php?t=5478026
zerochan_2020   - https://nyaa.si/view/1304539 (не представлен на rutracker, 600+ GB!, много PNG)
Во всех случаях возможна уникальная идентификация картинки по %booru% + %id%, это играет очень важную роль.
Неправильно утверждать, что датасет основан исключительно на этих релизах (см. далее), но в целом где то так.

В данном датасете представлена сводка BCS_torr_stat.xls (структура очевидна) и листинг BCS_torr.tsv (3.839.005 строк):
TORR - корневая папке релиза (см. выше)
BOORU - имя имиджборды (см. выше)
FID - номер поста 
SOURCEFILE - имя финальной папки/архива и наименование собственно файла
             в большинстве релизов (моего авторства) имя файла сделано максимально информативным по структуре
             %website% - %id% - %copyright% ~ %characters% (%artist%) насколько это удалось на момент релиза
            однако иногда (рипы sankaku) в древних и особенно в чужих релизах имена файлов могут быть не столь удобны
IMAGESIZE - размер "ШИРИНАхВЫСОТА"
FILESIZE - объем файла
IFMT - формат определенный EXIFTOOL
FDATE - дата файла в релизе (чаще это не дата поста а дата скачивания или последнего преобразования)
FMD5 - контрольная сумма MD5 посчитанная FCIV
       она принадлежит уже файлу в торренте - после всех его изменений в частности массового PNG -> JPG.
       Конверсия PNG -> JPG всегда выполнялась с одинаковыми параметрами (качество 94%, остальные настройки libjpeg 
       по умолчанию) поэтому один и тот же PNG всегда дает тот же JPG, что очень пригождается.
ZPATH - путь к финальной папке/архиву от корневой папки торрента, очень часто пустой т.е. архив находится в корне релиза

Следующим уровнем организации информации является "основной архив" - единый набор файлов из всех источников и релизов, в котором:
- обеспечивается уникальность BOORU + FID
- обеспечивается уникальность MD5
- выполняется более тщательная сквозная дедубликация, очистка некондиции и "улучшающие" преобразования изображений
Помимо упомянутых "первичных" релизов, в нем использован ряд весьма древних (на данный момент) "обойных" релизов :
обои FULL HD         - https://rutracker.org/forum/viewtopic.php?t=4199478 (на 2014 год)
обои Retina и Ultra  - https://rutracker.org/forum/viewtopic.php?t=4134758
обои sub-HD          - https://rutracker.org/forum/viewtopic.php?t=4214016
2015 HD Retina Ultra - https://rutracker.org/forum/viewtopic.php?t=5038341 (продолжение через год)
Wallpapers 2016      - https://rutracker.org/forum/viewtopic.php?t=5219029 (еще через год, тут и я обломался)
вертикальные обои для планшетов - https://rutracker.org/forum/viewtopic.php?t=4490693 (хорошая идея, плохой выбор "стандартов")
вертикальные обои продолжение   - https://rutracker.org/forum/viewtopic.php?t=5098506
вертикальные обои ULTRA-HD      - https://rutracker.org/forum/viewtopic.php?t=5198985 (2015, очень трудоемкие релизы)
где "первичные" картинки приведены к ряду "стандартных" размеров и в ряде случаев "улучшены", заменив собой оригиналы.
Изображения из "обойных" релизов представлены как том V2016W и покрывают все предшествующие даты постинга, делая тома 
2015 и 2016 довольно "грязными" (содержащими множество картинок, не прошедших в обои по эстетическим/качественным соображениям).

"Основной архив" структурирован по хронологии (примерно по годам постинга на бордах) и соотношению сторон :
* 7x10 +/- 4% страницы артбуков
* 3x4 +/- 10% "широкие" страницы
* 1x1 +/- 20% примерно "квадратные"
* 3x2 +/- 40% ландшафтная ориентация, в том числе обои
* 2x3 +/- 40% "высокие" страницы, имена папок начинаются с 1х2
образуя 48 "томов". На формирование томов последних лет оказывает влияние периодичность композитных рипов Safebooru.

В релизе представлена сводка BCS_arch_stat.xls (структура очевидна) и листинг BCS_arch.tsv (1.952.491 строк):
BOORU - имиджборда
FID - номер поста, очень редко (при разбиении картинки на фреймы) номер поста искажен суффиксом 00х, где х - фрейм
FVOLUME - том (например, v2020d.7x10)
FILENAME - имя файла по структуре %website% - %id% - %copyright% ~ %characters% (%artist%)
           по сравнению с "исходными" релизами имена файлов часто улучшены (дополнены, подчищены) и этот процесс перманентен
IMAGESIZE - размер "ШИРИНАхВЫСОТА"
FILESIZE - объем файла
JPEGQ - качество определенное EXIFTOOL
FMD5 - контрольная сумма MD5 посчитанная FCIV

Очень важны результаты парсинга метаданных booru (в чем я продвинулся относительно недавно благодаря python).
Ряд сайтов отдают по запросу готовые структуры JSON, для других приходится разбирать html-странички, в поисках:
- тегов (типизированных или хоть каких то)
- информации о картинке (дата постинга, размеры, объем, MD5, прямой URL)
- оценочной информации сообщества (рейтинг, популярность и др.)
Обходя страничку за страничкой по номеру поста в конечном итоге в локальной базе оказывается все, до чего можно докопаться
и появляется возможность "улучшить" имя файла, визуально перепроверить картинки с "неприличными" тегами и т.д.

Именно "основной архив" и (относительно недавно добытые) метаданные booru являются непосредственными источниками датасета.

Собственно BOORU CHARS dataset, представленный в релизе, состоит из массива из 1.593.429 изображений:
* sample-файлов "основного архива" уменьшеных до 1280px по длинной стороне (1024px для пропорции 1х1)
  for /d %%r in (D:\BC7\V2021A.7x10\*) do magick mogrify -path B:\BCT\V2021A.7x10 -verbose -thumbnail 1280x1280^ "%%r\*.jpg"
* для JPEG с качеством 98-100% дополнительно было сделано понижение до 94%
  magick mogrify -path B:\BCT\V2021A.7x10\#LSO -verbose -quality 94 "B:\BCT\V2021A.7x10\#LST\*.jpg"
Выбор таких параметров позволил достичь компромисса:
* картинки вполне презентабельны на мобильных устройствах и не слишком развесистых десктопах, размер подходит для процессинга
* при этом средний объем порядка 350kb позволил релизу удержаться в рамках разумного (полтерабайта - широкие рамки, однако)
При включении в датасет "основной архив" был подфильтрован:
* не включены тома 2015 года, а также не-обойные тома 2016 за исключением некоторой части 7х10 (слишком "грязные")
* исключены картинки с качеством JPEG до 75% (с артефактами), занявшие после компрессии до 90000 байт (малоинформатичные),
  а также занявшие после компрессии более 900000 байт (специфические шумы, "раздувающие" JPEG)
Картинки перегруппированы/укрупнены в 18 томов-папок по соотношению сторон и хронологии 
(2016 = все до 2018, 2018 = 2018 + 1x2 из 2016W, 2019 = 2019 + 2020a + 2020b, 2020 = остальные 2020 + 2021a).

Далее над ними выполнен расчет стат характеристик с использованием ImageMagick, где в цикле выполнено
    magick identify -format """%%f"";%%d;%%@;%%[entropy];%%[skewness];%%[fx:mean];%%[fx:standard_deviation];%%k;" "file_name" >> "log"
    magick convert "file_name" -colorspace HCL -format "%%[fx:mean.g];%%[fx:maxima.g];" info: >> "log"
    magick convert "file_name" -edge 3 -format "%%[fx:mean]\n" info: >> "log"
Полученный лог занесен в БД и характеристики использованы для переименования/разбиения картинок по небольшим (до 1000)
подпапкам/архивам на основе их визуального подобия (подробности об исследовании см. в отдельном readme).
Архивы именованы как Mxx (главный список) и Rxx (реверсивный список), их размер (250-500 МБ) приемлем для мобильных устройств.

Также для каждого файла произведено занесение ключевых тегов в более-менее подходящие поля EXIF-info
    exiftool -P -overwrite_original_in_place 
      -EXIF:Copyright="copyright" -EXIF:Software="BOORU - FID" -EXIF:Artist="artist" 
      -EXIF:Make="copyright [artist]" -EXIF:Model="character" "file_name"
Таким образом инструменты файловой системы (проводник Windows) и просмотрщики картинок (например, Perfect Viewer for Android,
BTW он смотрит картинки прямо в архивах) удобно отображают сопутствующую информацию.

Метаданные собственно о постах (картинках) вошедших в релиз собраны в листинг BC_posts.tsv (1.593.429 строк):
BOORU - имиджборда
FID - номер поста
TORR_PATH - путь в структуре релиза: корневая папка-том / папка-архив по списочному рейтингу
TORR_FNAME - имя файла в релизе
TORR_FSIZE - объем файла
TORR_ISIZE - размер sample изображения "ШИРИНАхВЫСОТА" в релизе
* далее идут стат характеристики sample изображения
* подробности об их исследовании и возни с "рейтинговой функцией" см. в отдельном readme
BOUNDBOX - фрейм с содержательной частью картинки за вычетом однородный полей
S_JQ - JPEG quality estimation
R_ALL - номер в рейтинге в пределах тома, "+" главный рейтинг (папки Мxx) "-" реверсивный рейтинг (папки Rxx)
TENTR - enthropy, мера "сложности" картинки, обширный однородный фон снижает энтропию, артефакты сканирования - повышают
R_ENTR - рейтинг по значению энтропии в пределах тома ( "-" позиция в реверсивном списке ) 1 - лидер, ххххх - в хвосте списка
TSKEW - skewness, мера "яркости", значительные "-" знаменуют приоритет светлых/белых тонов, "+" победила тьма
TSTDDEV - standard deviation, мера контрастности картинки в целом
R_SDEV - рейтинг по значению контрастности в пределах тома
TCOLORS - количество разных цветов, бОльшее число характеризует широкую цветовую гамму
R_COLOR - рейтинг по значению количества цветов в пределах тома
MEANG - mean grey, мера насыщенности цветов для картинки в целом
R_MEANG - рейтинг по значению насыщенности в пределах тома
EDGE - canny edge detector, мера количества линий разграничения между объектами, в отличии от энтропии отражает "макро" сложность
R_EDGE - рейтинг по значению edge в пределах тома
* несколько полей описывают изображения "основного архива", послужившего источником sample
ORIG_FSIZE - объем файла
ORIG_ISIZE - размер изображения "ШИРИНАхВЫСОТА"
ORIG_JQ - JPEG quality
ORIG_MD5 - контрольная сумма MD5
* следующие поля отражают информацию booru, во многих случаях они не заполнены или содержат значение по умолчанию
POST_DT - дата постинга
RATING - рейтинг Safe / Questionable / Explicit (встречается крайне редко и не оправдан) / None (нет информации)
SCORE - популярность поста на booru (не для всех booru, имеет смысл только как относительная в пределах booru)
FAVS - количество фаворитов на booru
POST_EXT - оригинальное расширение картинки поста, если это не JPG то изображение гарантированно конвертилось
POST_FSIZE - объем файла картинки поста на booru, заполнен только если известен и не совпадает с ORIG_FSIZE
POST_ISIZE - размер изображения картинки поста на booru, заполнен только если известен и не совпадает с ORIG_ISIZE
POST_MD5 - контрольная сумма MD5 картинки поста на booru, заполнена только если известна и не совпадает с ORIG_MD5
* и еще группа полей, содержащая количества тегов разных категорий (см. BC_tags.tsv) для данного поста
TAGS_COPYR - (copyright) произведения или их эквиваленты
TAGS_CHARS - (character) персонажи
TAGS_ART - (artist) авторы
TAGS_GEN - (general) изображенные предметы и события
TAGS_ETC - (technical, others) прочие смысловые и технические признаки

В релизе представлен листинг BC_tags.tsv (35.222.997 строк) выкачанных и творчески обработанных тегов для постов, вошедших в релиз:
BOORU - имиджборда
FID - номер поста
TAG_CAT - категория тега
 прелесть сообщества booru в использовании (в основном) унифицированной системы обозначения смысловых элементов
 при этом отдельно выделяются (категоризируются):
   3 (copyright) произведения или их эквиваленты
   4 (character) персонажи
   1 (artist) авторы
   0 (general) изображенные предметы и события
   5 (technical, others) прочие смысловые и технические признаки
 даже если система категорий не соответствует описанному выше "стандарту DANBOORU", она может быть сведена к нему
TAG - текстовый тег соответствующего поста
 конкретные значения тегов стандартизированы заметно хуже, чем категории (поскольку поддерживаются несколькими community)
 присутствуют как синонимы, так и вариации написания (большие/маленькие буквы, подчеркивания или пробелы между словами и т.п.)
 огромное количество тегов "мусорные" - использованы всего несколько раз и не описывают ничего существенного
TAG_ID - номер тега в кодировке DANBOORU
 мною была проведена кропотливая работа по систематизации часто используемых тегов, в т.ч. сведению синонимов с разных booru
 в качестве "сдандарта" было использовано тегирование сайта DANBOORU, где помимо строчной формы тега поддерживается уникальный
 цифровой индекс - который и подставлен в данное поле
DANB_TAG - синонимичный или обобщающий тег DANBOORU
 в системе тегирования DANBOORU (мною же) было выполнено обобщение copyright и character тегов во "франшизы" - произведения 
 или их серии с преимущественно повторяющимся набором персонажей
 в данном поле листинга представлено строчное значение тега DANBOORU
 * для CAT in (0,1,5) DANBOORU-синоним для TAG, если он не совпадает с TAG
 * для CAT in (3,4) DANBOORU-франшиза для TAG, если она не совпадает с TAG

Сопровождающие сводные данные: BC_tags_stat.xls (в разрезе томов, booru и категорий), BC_tags_top.xls - часто используемые теги,
в которых порядок еще наводить и наводить.

Очевидной областью применения BOORU CHARS dataset является визуальный каталог персонажного anime/CG/game арта:
- датасет уже, насколько это возможно, приспособлен для просмотра на мобильных устройствах и анализа на десктопах
* информативные имена файлов и заполненные теги EXIF позволяют легко выделять тематические подмножества
** как прямо из архива
for %%F in ("B:\BCT\2016-7x10\*.zip") do 7z x -r -o"d:\sortarea\" "%%F" *sword*art*online*
** так из из разархивированной версии
xcopy /s B:\BCT\2016-7x10\*sword*art*online* d:\sortarea
* тома / архивы имеют оптимальный размер для обмена с носимыми устройствами (для рандомных слайдшоу - как минимум ...)
- загрузив посты и теги в БД открывается возможность отбора/упорядочения картинок по любым вообразимым SQL критериям 
генерируя BAT скрипты для манипуляций (например XCOPY, MOVE, imagick convert, python cv2) с собственно изображениями
** скажем, а не найдется ли у нас в пучинах полутора миллионов картинок каких нибудь ахтунгов
select 'xcopy "B:\BCT\'||e.ipath||'\'||e.fname||'" d:\sortarea\ /Y' xc, 
       d.booru, d.id, d.orig_tag tag_1, n.orig_tag tag_2
from bct_dt d
join bct e on e.booru=d.booru and e.fid=d.id
join bct_dt n on n.booru=d.booru and n.id=d.id and n.orig_tag in ('nude','naked')
where d.orig_tag in ('loli')

Дополнительные метаданные в БД позволяют погрузиться еще глубже в конкретные предметные области, см. описания 
BCI__readme.txt - об исследовании стат характеристик, ранжировании и X/Y диаграммах
BCN__readme.txt - детектирование "фрагментов тел" (notAI-tech NudeNet) и "сборка" из них персонажей
